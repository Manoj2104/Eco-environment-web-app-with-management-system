
{% block content %}
<section class="section events__v2 py-5" id="events">
  <div class="container">
    <div class="row mb-4">
      <div class="col-lg-6 mx-auto text-center">
        <span class="subtitle text-uppercase text-success">Dashboard</span>
        <h2 class="fw-bold">Your Local Eco Events</h2>
        <p class="text-muted">Track, join, and explore eco campaigns in your area.</p>
        {% if user.latitude and user.longitude %}
        <p class="text-muted small">📍 Your Location: <span id="user-location-name">Loading...</span></p>
        {% endif %}
        <button class="btn btn-outline-success btn-sm mt-2" onclick="setUserLocation()">📍 Use My Current Location</button>
        <div id="location-status" class="text-muted small mt-2"></div>
      </div>
    </div>

    {% if events %}
    <div class="d-flex overflow-auto gap-4 pb-2 event-scroll flex-nowrap">
      {% for e in events %}
        {% set event = e["event"] %}
        {% set status = e["status"] %}
        {% set now = current_time + timedelta(hours=5, minutes=30) %}

        <div class="card flex-shrink-0 p-3 rounded-4 shadow border-0 position-relative event-card bg-white" style="width: 260px;" id="event-card-{{ event.id }}">
          <div class="position-relative mb-2">
            <img src="{{ url_for('static', filename='uploads/' ~ (event.thumbnail or 'default.jpg')) }}"
                 class="img-fluid rounded-3 shadow-sm w-100"
                 style="height: 140px; object-fit: cover;">
            <span class="badge position-absolute top-0 start-0 m-2 px-2 py-1 rounded-2
              {% if event.date.date() == now.date() %}bg-warning text-dark
              {% elif event.date > now %}bg-success
              {% else %}bg-secondary{% endif %}">
              {% if event.date.date() == now.date() %}Today
              {% elif event.date > now %}Upcoming
              {% else %}Past{% endif %}
            </span>
          </div>

          <h6 class="fw-bold fs-6 mb-1 text-truncate" title="{{ event.title }}">{{ event.title }}</h6>
          <p class="text-muted small text-truncate mb-1"><i class="bi bi-geo-alt me-1"></i> {{ event.location }}</p>
          <p class="text-muted small mb-2"><i class="bi bi-calendar3 me-1"></i> {{ event.date.strftime('%d %b %Y %I:%M %p') }}</p>

          <div class="small text-muted mb-2 distance-label"
               id="distance-{{ event.id }}"
               data-lat="{{ event.latitude }}"
               data-lon="{{ event.longitude }}">
            📍 Calculating...
          </div>

          {% if event.badge %}
            <div class="badge bg-info text-white small mb-2"><i class="bi bi-award me-1"></i>{{ event.badge }}</div>
          {% endif %}

          <div class="mb-2 small text-muted">
            <i class="bi bi-stars me-1"></i>{{ event.xp_reward or 0 }} XP
          </div>

          {% if current_user.role == 'volunteer' %}
          <div id="btn-container-{{ event.id }}">
            {% if status.task_completed %}
              <button class="btn btn-outline-success btn-sm w-100" disabled>✅ Completed</button>
            {% elif status.task_started %}
              <button class="btn btn-info btn-sm w-100" onclick="launchTaskModal({{ event.id }})">🧠 Start Task</button>
            {% elif status.checked_in %}
              <button class="btn btn-outline-success btn-sm w-100" disabled>✅ Checked In</button>
              <script> setTimeout(() => showAssigningTask({{ event.id }}), 10000); </script>
            {% elif status.booked %}
              <button class="btn btn-warning btn-sm w-100 countdown-btn"
                      id="event-btn-{{ event.id }}"
                      data-event-id="{{ event.id }}"
                      data-event-time="{{ event.date.isoformat() }}">
                📌 Booked
              </button>
            {% else %}
              <button class="btn btn-primary btn-sm w-100"
                      onclick="showBookingModal({{ event.id }}, '{{ event.date.strftime('%Y-%m-%dT%H:%M') }}')">
                ➕ Join
              </button>
            {% endif %}
          </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center mt-5">
      <h5 class="text-muted">No nearby eco events found within <strong>8 km</strong>.</h5>
    </div>
    {% endif %}
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// ✅ Location Update
function setUserLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(position => {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      localStorage.setItem("userLat", lat);
      localStorage.setItem("userLon", lon);
      document.getElementById("location-status").innerText = "✅ Location updated!";
      updateEventDistances();
    }, error => {
      document.getElementById("location-status").innerText = "❌ Location access denied.";
    });
  } else {
    document.getElementById("location-status").innerText = "❌ Geolocation not supported.";
  }
}

// ✅ Haversine Distance
function haversineDistance(lat1, lon1, lat2, lon2) {
  const toRad = x => x * Math.PI / 180;
  const R = 6371;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// ✅ Update Distance
function updateEventDistances() {
  const userLat = parseFloat(localStorage.getItem("userLat"));
  const userLon = parseFloat(localStorage.getItem("userLon"));
  if (isNaN(userLat) || isNaN(userLon)) return;

  document.querySelectorAll(".distance-label").forEach(el => {
    const lat = parseFloat(el.dataset.lat);
    const lon = parseFloat(el.dataset.lon);
    if (!isNaN(lat) && !isNaN(lon)) {
      const dist = haversineDistance(userLat, userLon, lat, lon);
      el.innerText = `📍 ${dist.toFixed(1)} km away`;
    }
  });
}

// ✅ Countdown + Button Transitions
function updateCountdownButtons() {
  const now = new Date().getTime();

  document.querySelectorAll(".countdown-btn").forEach(btn => {
    const eventTime = new Date(btn.dataset.eventTime).getTime();
    const eventId = btn.dataset.eventId;
    const diff = eventTime - now;
    const past = now - eventTime;
    const container = document.getElementById("btn-container-" + eventId);

    if (diff > 30 * 60 * 1000) {
      btn.innerText = "📌 Booked";
    } else if (diff > 15 * 60 * 1000) {
      const mins = Math.floor(diff / 60000);
      const secs = Math.floor((diff % 60000) / 1000);
      btn.innerText = `⏳ Starts in ${mins}:${secs.toString().padStart(2, '0')}`;
    } else if (diff > 0) {
      btn.classList.remove("btn-warning");
      btn.classList.add("btn-primary");
      btn.innerText = "🕑 Check-In";
      btn.onclick = () => triggerCheckIn(eventId);
    } else if (past <= 10 * 60 * 1000) {
      btn.classList.remove("btn-primary");
      btn.classList.add("btn-secondary");
      btn.innerText = "🕑 Last Check-In";
      btn.onclick = () => triggerCheckIn(eventId);
    } else if (past > 45 * 60 * 1000) {
      const card = document.getElementById("event-card-" + eventId);
      if (card) card.remove();
    } else {
      btn.classList.remove("btn-secondary");
      btn.classList.add("btn-dark");
      btn.innerText = "🕒 Missed";
      btn.disabled = true;
    }
  });
}

function triggerCheckIn(eventId) {
  fetch('/verify-checkin-alt', {
    method: 'POST',
    body: new URLSearchParams({ event_id: eventId, passcode: '1234' }) // replace with real check-in logic
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert("✅ Checked In");
      location.reload();
    } else {
      alert("❌ " + data.message);
    }
  });
}

// ✅ Init
document.addEventListener("DOMContentLoaded", () => {
  updateEventDistances();
  updateCountdownButtons();
  setInterval(updateCountdownButtons, 1000);
});
</script>
{% endblock %}


