{% extends "base.html" %}
{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  .card-super {
    background: linear-gradient(135deg, #ffffff, #e8f5e9);
    border-radius: 20px;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    padding: 40px;
    transition: transform .3s;
  }
  .card-super:hover { transform: translateY(-5px); }
  .form-label { font-weight: 600; color: #2e7d32; }
  #map { border-radius: 12px; border: 2px solid #c8e6c9; }
  .dropzone {
    border: 2px dashed #a5d6a7; background: #f1f8e9;
    border-radius: 12px; cursor: pointer; padding: 40px;
    text-align: center;
  }
  .voicelabel { position: relative; }
  .voicelabel .mic {
    position: absolute; right: 12px; top: 50%;
    transform: translateY(-50%); opacity: .6; cursor: pointer;
  }
  #suggestions {
    max-height: 180px;
    overflow-y: auto;
    z-index: 1000;
  }
</style>

<div class="card-super mb-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="text-success mb-0"><i class="bi bi-calendar-plus me-2"></i>Create New Event</h3>
    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#bulkEventModal">
      <i class="bi bi-upload me-1"></i> Bulk Upload
    </button>
  </div>

  <form method="POST" enctype="multipart/form-data" action="{{ url_for('events.create_event') }}">
    <div class="row g-4">

      <div class="col-md-6">
        <label class="form-label">Event Title</label>
        <div class="voicelabel">
          <input type="text" name="title" id="title" class="form-control" required>
          <i class="bi bi-mic-fill mic"></i>
        </div>
      </div>

      <div class="col-md-2">
        <label class="form-label">Start Date & Time</label>
        <input type="datetime-local" name="date" class="form-control" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">Duration (h)</label>
        <input type="number" name="duration" class="form-control" min="1" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">XP Score</label>
        <input type="number" name="xp_score" class="form-control" min="0">
      </div>

      <!-- Location + Suggestion -->
      <div class="col-md-6 position-relative">
        <label class="form-label">Location</label>
        <input type="text" name="location" id="locationInput" class="form-control" placeholder="Type shop, place, street..." autocomplete="off" required>
        <ul id="suggestions" class="list-group position-absolute w-100"></ul>
      </div>

      <!-- Map -->
      <div class="col-md-6">
        <label class="form-label">Map Preview</label>
        <div id="map" style="height: 240px;"></div>
      </div>

      <!-- Passcode & QR -->
      <div class="col-md-4">
        <label class="form-label">Check-In Passcode</label>
        <div class="input-group">
          <input type="text" name="passcode" id="passcode" class="form-control" required oninput="debouncedQR()">
          <button type="button" class="btn btn-outline-secondary" onclick="generatePasscode()">üé≤</button>
        </div>
      </div>
      <div class="col-md-2">
        <label class="form-label">QR Code</label>
        <div class="border rounded bg-white p-2 text-center">
          <img id="qrImage" src="" style="max-width: 120px;" />
        </div>
      </div>

      <!-- Lat/Lng -->
      <div class="col-md-2">
        <label class="form-label">Latitude</label>
        <input type="text" name="latitude" id="latitude" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label">Longitude</label>
        <input type="text" name="longitude" id="longitude" class="form-control">
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="button" class="btn btn-outline-primary w-100" onclick="autoFillLocation()">
          üìç Use My Location
        </button>
      </div>

      <!-- Category -->
      <div class="col-md-3">
        <label class="form-label">Category</label>
        <select name="category" class="form-select">
          <option>Cleanup</option>
          <option>Awareness</option>
          <option>Tree Plantation</option>
          <option>Waste Management</option>
        </select>
      </div>

      <!-- Tags -->
      <div class="col-md-3">
        <label class="form-label">Tags</label>
        <input type="text" name="tags" class="form-control" placeholder="eco,cleanup,awareness">
      </div>

      <div class="col-md-3">
        <label class="form-label">Repeat?</label>
        <select name="repeat" class="form-select">
          <option>No</option>
          <option>Weekly</option>
          <option>Monthly</option>
        </select>
      </div>

      <!-- Thumbnail -->
      <div class="col-md-6">
        <label class="form-label">Thumbnail</label>
        <div id="dropzone" class="dropzone">
          <input type="file" name="thumbnail" id="thumbnail" accept="image/*" class="d-none" required>
          <p>Drop image here or click to upload</p>
        </div>
        <img id="thumbPreview" class="img-thumbnail mt-2 shadow-sm" style="max-height: 180px; display: none;">
      </div>

      <div class="col-md-12">
        <label class="form-label">Event Description</label>
        <textarea name="description" class="form-control" rows="3" required></textarea>
      </div>

      <div class="col-md-12">
        <label class="form-label">Volunteer Instructions / Safety Tips</label>
        <textarea name="instructions" class="form-control" rows="2"></textarea>
      </div>

      <div class="col-md-12 text-end">
        <button type="submit" class="btn btn-success px-5 py-2 shadow-sm">
          <i class="bi bi-check-circle me-1"></i> Create Event
        </button>
      </div>
    </div>
  </form>
</div>

<!-- Bulk Upload Modal -->
<div class="modal fade" id="bulkEventModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form method="POST" enctype="multipart/form-data" action="{{ url_for('events.bulk_create') }}">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="bi bi-upload me-2"></i> Bulk Event Upload</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Upload a <code>.csv</code> with: title,date,duration,xp_score,location,lat,lon,passcode,category,tags,description</p>
          <a href="/static/template.csv" class="btn btn-link"><i class="bi bi-download"></i> Download Sample</a>
          <input type="file" name="bulk_file" accept=".csv" class="form-control mt-2" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary"><i class="bi bi-cloud-upload"></i> Upload</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // Init map
  const map = L.map('map').setView([13.0827, 80.2707], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  const marker = L.marker([13.0827, 80.2707], { draggable: true }).addTo(map);
  marker.on('dragend', () => {
    const { lat, lng } = marker.getLatLng();
    document.getElementById('latitude').value = lat.toFixed(6);
    document.getElementById('longitude').value = lng.toFixed(6);
  });

  function autoFillLocation() {
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      document.getElementById("latitude").value = latitude.toFixed(6);
      document.getElementById("longitude").value = longitude.toFixed(6);
      marker.setLatLng([latitude, longitude]);
      map.setView([latitude, longitude], 14);
    }, () => alert("Location not available"));
  }

  let qrTimer;
  function debouncedQR() {
    clearTimeout(qrTimer);
    qrTimer = setTimeout(generateQR, 300);
  }

  function generateQR() {
    const passcode = document.getElementById('passcode').value;
    if (passcode.length > 0) {
      document.getElementById('qrImage').src =
        `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(passcode)}`;
    }
  }

  function generatePasscode() {
    const rand = Math.random().toString(36).substring(2, 8);
    document.getElementById('passcode').value = 'eco' + rand;
    generateQR();
  }

  document.getElementById('dropzone').addEventListener('click', () => {
    document.getElementById('thumbnail').click();
  });

  document.getElementById('thumbnail').addEventListener('change', function (event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = function () {
      const img = document.getElementById('thumbPreview');
      img.src = reader.result;
      img.style.display = 'block';
    };
    if (file) reader.readAsDataURL(file);
  });

  // Location autocomplete
  const input = document.getElementById('locationInput');
  const list = document.getElementById('suggestions');
  let debounce;

  input.addEventListener('input', () => {
    clearTimeout(debounce);
    const query = input.value.trim();
    if (query.length < 2) {
      list.innerHTML = '';
      return;
    }
    debounce = setTimeout(() => {
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=6`)
        .then(res => res.json())
        .then(data => {
          list.innerHTML = '';
          data.forEach(loc => {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action';
            li.textContent = loc.display_name;
            li.onclick = () => {
              input.value = loc.display_name;
              list.innerHTML = '';
              const lat = parseFloat(loc.lat), lon = parseFloat(loc.lon);
              document.getElementById('latitude').value = lat.toFixed(6);
              document.getElementById('longitude').value = lon.toFixed(6);
              marker.setLatLng([lat, lon]);
              map.setView([lat, lon], 14);
            };
            list.appendChild(li);
          });
        });
    }, 300);
  });

  document.addEventListener('click', e => {
    if (!input.contains(e.target) && !list.contains(e.target)) {
      list.innerHTML = '';
    }
  });
</script>

{% endblock %}
