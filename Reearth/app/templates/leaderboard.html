{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <!-- Heading & Controls -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-3">
    <h2 class="text-primary m-0"><i class="bi bi-trophy-fill me-2"></i>Leaderboard</h2>
    <div class="d-flex gap-2 flex-wrap">
      <input type="text" class="form-control" id="searchInput" placeholder="🔍 Search user...">
      <select id="sortOption" class="form-select">
        <option value="xp" selected>Sort by XP</option>
        <option value="level">Sort by Level</option>
      </select>
    </div>
  </div>

  <!-- Leaderboard Card -->
  <div class="card shadow-sm rounded-4">
    <div class="card-body p-3">
      {% for user in top_users %}
      <div class="d-flex align-items-center justify-content-between py-3 px-2 border-bottom user-row" data-xp="{{ user.xp }}" data-level="{{ user.level or 1 }}">
        <div class="d-flex align-items-center">
          <span class="fs-5 fw-bold me-3 text-muted">
            {% if loop.index == 1 %} 🥇
            {% elif loop.index == 2 %} 🥈
            {% elif loop.index == 3 %} 🥉
            {% else %} {{ loop.index }}.
            {% endif %}
          </span>

          <!-- Avatar / Initial Fallback -->
<div class="me-3">
  {% if user.avatar_url %}
    <img src="{{ user.avatar_url }}"
         alt="{{ user.name }}"
         width="48" height="48"
         class="rounded-circle border"
         onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/default-profile.png') }}';">
  {% else %}
    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center fw-semibold"
         style="width: 48px; height: 48px; font-size: 16px;">
      {{ user.name.split()[0][0] }}{% if user.name.split()|length > 1 %}{{ user.name.split()[1][0] }}{% endif %}
    </div>
  {% endif %}
</div>

          <!-- User Info -->
          <div>
            <div class="fw-semibold {{ 'text-primary' if user.is_current_user else '' }}">
              {{ user.name }} 
              {% if user.is_current_user %}
              <span class="badge bg-primary ms-2">You</span>
              {% endif %}
            </div>
            <small class="text-muted">
              Level {{ user.level or 1 }} · 
              <i class="bi bi-clock-history me-1"></i>{{ user.last_active or "N/A" }}
            </small>
          </div>
        </div>

        <!-- XP Progress -->
        <div class="text-end" style="min-width: 220px;">
          <div class="progress mb-1 rounded-pill shadow-sm" style="height: 10px;">
            <div class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                 style="width: {{ (user.xp / 1000 * 100) if user.xp <= 1000 else 100 }}%;"
                 aria-valuenow="{{ user.xp }}" aria-valuemin="0" aria-valuemax="1000">
            </div>
          </div>
          <span class="badge bg-success px-3" title="Total XP">{{ user.xp }} XP</span>
          {% if user.xp >= 1000 %}
            <span class="badge bg-warning text-dark ms-2">🏆 Gold</span>
          {% elif user.xp >= 500 %}
            <span class="badge bg-secondary ms-2">🥈 Silver</span>
          {% elif user.xp >= 250 %}
            <span class="badge bg-info text-dark ms-2">🥉 Bronze</span>
          {% else %}
            <span class="badge bg-light text-muted ms-2">🌱 Rookie</span>
          {% endif %}
        </div>
      </div>
      {% else %}
      <div class="text-muted text-center py-4">No leaderboard data available.</div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Search + Sort Script -->
<script>
  const searchInput = document.getElementById("searchInput");
  const sortOption = document.getElementById("sortOption");

  searchInput.addEventListener("keyup", function () {
    const value = this.value.toLowerCase();
    document.querySelectorAll(".user-row").forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(value) ? "" : "none";
    });
  });

  sortOption.addEventListener("change", function () {
    const type = this.value;
    const rows = Array.from(document.querySelectorAll(".user-row"));
    rows.sort((a, b) => {
      return b.dataset[type] - a.dataset[type];
    });
    const container = rows[0].parentNode;
    rows.forEach(row => container.appendChild(row));
  });
</script>
{% endblock %}
