{% extends 'base.html' %}
{% block title %}XP Progress | EcoNova{% endblock %}

{% block content %}
<div class="container mt-5">
  <h3 class="mb-4 text-success"><i class="bi bi-graph-up-arrow me-2"></i>XP Progress Overview</h3>

  <!-- Quote -->
  <div class="alert alert-info shadow-sm rounded-pill text-center fw-semibold">
    üå± ‚ÄúEvery step you take plants a seed of impact. Keep earning, keep growing!‚Äù
  </div>

  <!-- Badges -->
  <div class="mb-4 d-flex gap-2 flex-wrap justify-content-center">
    <span class="badge rounded-pill bg-primary px-3 py-2"><i class="bi bi-lightning-charge-fill me-1"></i> Active</span>
    <span class="badge rounded-pill bg-success px-3 py-2"><i class="bi bi-award-fill me-1"></i> Consistent</span>
    <span class="badge rounded-pill bg-warning text-dark px-3 py-2"><i class="bi bi-star-fill me-1"></i> Top 10%</span>
    <span class="badge rounded-pill bg-danger px-3 py-2"><i class="bi bi-fire me-1"></i> Streak</span>
  </div>

  <!-- Summary Cards -->
  <div class="row g-3 mb-4">
    {% set cards = [
      ('Current XP', current_xp, 'bi-lightning', 'primary'),
      ('Current Level', current_level, 'bi-bar-chart-fill', 'success'),
      ('Next Level', next_level, 'bi-stars', 'warning'),
      ('XP to Level Up', xp_remaining, 'bi-hourglass-split', 'danger')
    ] %}
    {% for title, value, icon, color in cards %}
    <div class="col-md-3">
      <div class="card shadow rounded-4 text-center border-0 animate__animated animate__fadeInUp">
        <div class="card-body">
          <i class="bi {{ icon }} fs-3 text-{{ color }}"></i>
          <h6 class="text-muted mt-2">{{ title }}</h6>
          <h4 class="text-{{ color }} fw-bold">{{ value }}</h4>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- XP Progress Bar -->
  <div class="mb-4">
    <label class="form-label">XP Progress to Next Level</label>
    <div class="progress rounded-pill" style="height: 25px;">
      <div class="progress-bar bg-info progress-bar-striped progress-bar-animated"
           style="width: {{ xp_percent }}%;" aria-valuenow="{{ xp_percent }}"
           aria-valuemin="0" aria-valuemax="100">
        {{ xp_percent }}%
      </div>
    </div>
  </div>

  <!-- Chart + Download Button -->
  <div class="card shadow-sm rounded-4 p-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5><i class="bi bi-bar-chart-line-fill me-2"></i>XP Growth Chart</h5>
      <a href="/download-xp-report" class="btn btn-outline-success btn-sm">
        <i class="bi bi-download me-1"></i> Download Report
      </a>
    </div>
    <canvas id="xpChart" height="120"></canvas>
  </div>

  <!-- XP Milestones -->
  <div class="card shadow-sm rounded-4 p-4 mb-5">
    <h5 class="mb-4"><i class="bi bi-trophy-fill me-2 text-warning"></i>Milestone Timeline</h5>
    <ul class="timeline list-unstyled">
      {% for milestone in milestones %}
      <li class="mb-4 position-relative ps-4">
        <span class="position-absolute top-0 start-0 translate-middle-y">
          <i class="bi bi-check-circle-fill text-success fs-5"></i>
        </span>
        <div>
          <h6 class="mb-1">{{ milestone.title }}</h6>
          <p class="mb-0 text-muted small">{{ milestone.date }}</p>
        </div>
      </li>
      {% else %}
      <div class="text-muted">No XP milestones achieved yet.</div>
      {% endfor %}
    </ul>
  </div>

  <!-- Achievements Gallery -->
  <div class="card shadow-sm rounded-4 p-4 mb-5">
    <h5 class="mb-4"><i class="bi bi-gem text-purple me-2"></i>Unlocked Achievements</h5>
    <div class="d-flex flex-wrap gap-3">
      <div class="text-center">
        <i class="bi bi-patch-check-fill fs-2 text-success"></i>
        <p class="small mt-1 mb-0">Verified Hero</p>
      </div>
      <div class="text-center">
        <i class="bi bi-hourglass-top fs-2 text-warning"></i>
        <p class="small mt-1 mb-0">Early Riser</p>
      </div>
      <div class="text-center">
        <i class="bi bi-globe fs-2 text-primary"></i>
        <p class="small mt-1 mb-0">Global Impact</p>
      </div>
    </div>
  </div>

  <!-- Real-time Leaderboard -->
  <div class="card shadow-sm rounded-4 p-4 mb-5">
    <h5 class="mb-4"><i class="bi bi-trophy text-warning me-2"></i>Leaderboard Preview</h5>
    <table class="table table-sm table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>XP</th>
          <th>Level</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body">
        <tr><td colspan="4" class="text-center text-muted">Loading leaderboard...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Pro Tip -->
  <div class="alert alert-light border-start border-info shadow-sm">
    <i class="bi bi-lightbulb-fill me-2 text-info"></i>
    <strong>Pro Tip:</strong> Complete your profile, participate in high-impact events, and maintain check-in streaks for bonus XP.
  </div>

  <!-- Chart.js -->
  {% if xp_labels and xp_history %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('xpChart').getContext('2d');
    const xpChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: {{ xp_labels | tojson }},
        datasets: [{
          label: 'XP Earned',
          data: {{ xp_history | tojson }},
          borderColor: '#198754',
          backgroundColor: 'rgba(25, 135, 84, 0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          x: { title: { display: true, text: 'Month' } },
          y: {
            beginAtZero: true,
            title: { display: true, text: 'XP' }
          }
        }
      }
    });
  </script>
  {% endif %}

  <!-- Real-time Leaderboard Socket.IO -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io();
    socket.emit('request_leaderboard');

    socket.on('update_leaderboard', data => {
      const tbody = document.querySelector('#leaderboard-body');
      tbody.innerHTML = '';
      data.forEach((user, index) => {
        const tr = document.createElement('tr');
        const isCurrentUser = user.name === '{{ current_user.name }}';
        tr.className = isCurrentUser ? 'table-success fw-semibold' : '';
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${isCurrentUser ? '<strong>You</strong>' : user.name}</td>
          <td>${user.xp}</td>
          <td>${user.level}</td>
        `;
        tbody.appendChild(tr);
      });
    });
  </script>

</div>

<!-- Animate.css -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" />
{% endblock %}
